name: CI

on: [push, pull_request, workflow_dispatch]

jobs:

  build:

    runs-on: macos-latest

    steps:

    - uses: actions/checkout@v4

    - name: Get Lilu SHA
      id: get-lilu-sha
      run: |
        echo "::set-output name=hash::$(git ls-remote https://github.com/acidanthera/Lilu.git HEAD | awk '{ print $1 }')"

    - name: Cache Lilu
      id: cache-lilu
      # LÆ°u Ã½: actions/cache@v3 váº«n an toÃ n Ä‘á»ƒ sá»­ dá»¥ng
      uses: actions/cache@v3
      with:
        path: Lilu.kext
        key: Lilu-${{ steps.get-lilu-sha.outputs.hash }}

    - name: Install MacKernelSDK
      run: |
        git clone --depth=1 https://github.com/acidanthera/MacKernelSDK.git

    - name: Install Lilu SDK
      if: steps.cache-lilu.outputs.cache-hit != 'true'
      run: |
        git clone --depth=1 https://github.com/acidanthera/Lilu.git
        cd Lilu || exit 1
        ln -s ../MacKernelSDK MacKernelSDK
        # Sá»­ dá»¥ng pipefail Ä‘á»ƒ Ä‘áº£m báº£o lá»‡nh xcodebuild tháº¥t báº¡i náº¿u xcpretty tháº¥t báº¡i
        set -o pipefail
        xcodebuild -configuration Debug -arch x86_64 | xcpretty && ret=${PIPESTATUS[0]}
        if [[ $ret -ne 0 || ! -d build/Debug/Lilu.kext ]]; then
          exit 1
        fi
        cp -R build/Debug/Lilu.kext ../

    - name: Debug Build
      run: |
        set -o pipefail
        xcodebuild -alltargets -configuration Debug | xcpretty && exit ${PIPESTATUS[0]}

    - name: Release Build
      run: |
        set -o pipefail
        xcodebuild -alltargets -configuration Release | xcpretty && exit ${PIPESTATUS[0]}

    - name: Upload to Artifacts
      # ğŸš€ ÄÃ‚Y LÃ€ DÃ’NG ÄÃƒ ÄÆ¯á»¢C Cáº¬P NHáº¬T Tá»ª v3 SANG v4
      uses: actions/upload-artifact@v4 
      with:
        name: ${{ github.event.repository.name }}
        path: build/*/*.zip
        # LÆ¯U Ã: Tham sá»‘ if-no-files-found Ä‘Ã£ Ä‘Æ°á»£c Ä‘á»•i tÃªn thÃ nh strict trong v4, 
        # nhÆ°ng giÃ¡ trá»‹ 'error' lÃ  giÃ¡ trá»‹ máº·c Ä‘á»‹nh trong v4. 
        # TÃ´i giá»¯ nguyÃªn Ä‘á»ƒ rÃµ rÃ ng, máº·c dÃ¹ nÃ³ cÃ³ thá»ƒ Ä‘Æ°á»£c bá» Ä‘i.
        # GiÃ¡ trá»‹ má»›i Ä‘Æ°á»£c khuyáº¿n nghá»‹ lÃ  'strict: true'
        # TÃ´i sáº½ thay Ä‘á»•i nÃ³ Ä‘á»ƒ sá»­ dá»¥ng tham sá»‘ má»›i:
        strict: true
